{% extends 'include/include.html' %} {% block content %}
<head>
  <style>
  .table-responsive {
    overflow-x: auto; /* Menambahkan scroll horizontal jika diperlukan */
  }
  
</style>
</head>
<div class="page-titles">
    <div class="row">
      <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0 d-flex align-items-center">
            <li class="breadcrumb-item">
              <a href="index.html" class="link"
                ><i class="ri-home-3-line fs-5"></i
              ></a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">admin/dashboard</li>
          </ol>
        </nav>
        <h1 class="mb-0 fw-bold">Dashboard</h1>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <!-- ============================================================= -->
    <!-- Start Page Content -->
    <!-- ============================================================= -->
    <!-- Row -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Welcome admin {{ session['username'] }}</h4>
            <h6 class="card-subtitle mb-0">
              anda dapat mengedit data yang ada di tampilan user
            </h6>
          </div>
        </div>
      </div>
      <div class="col-12">
        <h1> Grafik Monografi</h1>
      </div> 
      <div class="col-lg-12">
        <div class="card w-100">
          <div class="card-body">
            <div class="d-md-flex align-items-center">
              <div>
                <h3 class="card-title">Monografi desa</h3>
                <h6 class="card-subtitle">Grafik perbandingan menografi desa per tahun</h6>
              </div>
              <div class="ms-auto">
                <ul class="list-style-none">
                  <div class="container-fluid">
                    <div class="row mb-4">
                      <div class="col-lg-6">
                        <label for="categoryDropdown">Pilih Kategori:</label>
                        <select id="categoryDropdownmono" style="min-width: 150px;" class="form-control" multiple>
                          {% for field in fields_mono %}
                          <option value="{{ field.value }}">{{ field.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-lg-6">
                        <label for="yearDropdown">Pilih Tahun:</label>
                        <select id="yearDropdownmono" class="form-control" multiple>
                          {% for item in info_mono %}
                          <option value="{{ item.tahun }}">{{ item.tahun }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </ul>
              </div>
            </div>
            <div class="table-responsive">
            <div id="chart_mono" class="mt-4"></div>
          </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card w-100">
          <div class="card-body">
            <div class="d-md-flex align-items-center">
              <div class="col-md-8 col-lg-3">
                <h3 class="card-title">Geografi</h3>
                <h6 class="card-subtitle">Grafik Perubahan Geografi Desa (luas wilayah)</h6>
              </div>
              <div class="ms-auto ">
                <ul class="list-style-none">
                  <div class="container-fluid p-0">
                    <div class="row mb-4">
                      <div class="col-lg-6">
                        <label for="categoryDropdown">Pilih Kategori:</label>
                        <select id="categoryDropdowngeo" style="min-width: 150px;" class="form-control" multiple>
                          {% for field in fields_geo %}
                          <option value="{{ field.value }}">{{ field.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-lg-6">
                        <label for="yearDropdown">Pilih Tahun:</label>
                        <select id="yearDropdowngeo" class="form-control" multiple>
                          {% for item in info_geo %}
                          <option value="{{ item.tahun }}">{{ item.tahun }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </ul>
              </div>
            </div>
            <div class="table-responsive">
            <div id="chart_geo" class="mt-4"></div>
            </div>
          </div>
        </div>
      </div>
      </div>
    {% endblock %}

    {% block js %}
<script>
$(document).ready(function() {
    // --- 1. DATA & MAPPING MONOGRAFI ---
    var data_mono = JSON.parse('{{info_mono|tojson}}');
    
    // Mapping: jkk (Jumlah KK) diletakkan di sebelah jpenduduk
    const mapping_mono = {
        "jpenduduk": "Jumlah Penduduk", 
        "jkk": "Jumlah KK", 
        "laki": "laki-laki", 
        "perempuan": "Perempuan",
        "jkkprese": "Jumlah KK Presejahtera", 
        "jkkseja": "Jumlah KK Sejahtera", 
        "jkkkaya": "Jumlah KK Kaya", 
        "jkksedang": "Jumlah KK Sedang", 
        "jkkmiskin": "Jumlah KK Miskin", 
        "buruh": "Buruh", 
        "petani": "Petani", 
        "peternak": "Peternak", 
        "pedagang": "Pedagang",
        "tukangkayu": "Tukang Kayu", 
        "tukangbatu": "Tukang Batu", 
        "penjahit": "Penjahit",
        "asn": "ASN", 
        "pensiunan": "Pensiunan", 
        "perangkatdesa": "Perangkat Desa",
        "jasa_wiraswasta": "Jasa Wiraswasta", 
        "pengrajinbatik": "Pengrajin Batik", 
        "dll": "DLL",
        "islam": "Islam", 
        "kristen": "Kristen", 
        "protestan": "Protestan",
        "katolik": "Katolik", 
        "hindu": "Hindu", 
        "budha": "Budha"
    };

    var tahun_mono = data_mono.map(item => item.tahun);
    var series_awal = Object.keys(mapping_mono).map(key => ({
        name: mapping_mono[key],
        data: data_mono.map(item => item[key] || 0)
    }));

    // --- 2. INISIALISASI GRAFIK MONOGRAFI ---
    var options_mono = {
        series: series_awal,
        chart: { 
            type: "bar", 
            height: 350, 
            toolbar: { show: false } 
        },
        // MENGHILANGKAN ANGKA DI ATAS BATANG
        dataLabels: { 
            enabled: false 
        }, 
        plotOptions: { 
            bar: { 
                horizontal: false, 
                columnWidth: "50%", 
                borderRadius: 5 
            } 
        },
        xaxis: { 
            categories: tahun_mono 
        },
        yaxis: { 
            forceNiceScale: true 
        },
        tooltip: { 
            theme: "dark" 
        }
    };

    var chart_mono = new ApexCharts($("#chart_mono")[0], options_mono);
    chart_mono.render();

    // --- 3. FUNGSI FILTER (DROPDOWN) ---
    function updateChartMono() {
        var selectedYears = $("#yearDropdownmono").val() || [];
        var selectedCategories = $("#categoryDropdownmono").val() || [];
        
        var newSeries = selectedYears.map(year => {
            var row = data_mono.find(item => item.tahun == year) || {};
            return {
                name: year,
                data: selectedCategories.map(catKey => row[catKey] || 0)
            };
        });

        chart_mono.updateOptions({
            series: newSeries,
            dataLabels: { enabled: false }, // Tetap false saat update
            xaxis: { 
                categories: selectedCategories.map(key => mapping_mono[key] || key) 
            }
        });
    }

    $("#yearDropdownmono, #categoryDropdownmono").on('change', updateChartMono);

    // --- 4. LOGIKA ADMIN (FORM & KIRIM DATA) ---
    $('#tahun').on('change', function() {
        var row = data_mono.find(item => item.tahun == $(this).val());
        if (row) {
            Object.keys(mapping_mono).forEach(key => $(`[name=${key}]`).val(row[key]));
        }
    });

    $('#kirim').on('click', function () {
        let formData = new FormData();
        Object.keys(mapping_mono).forEach(key => formData.append(key, $(`[name=${key}]`).val()));
        formData.append('selected_tahun', $('#tahun').val());
        
        var submitMode = $(`[name='submit']`).val(); 
        $.ajax({
            url: submitMode === "edit" ? "/admin/edit_mono" : "/admin/tambah_mono",
            method: submitMode === "edit" ? 'PUT' : 'POST',
            data: formData,
            processData: false, 
            contentType: false,
            headers: { 'Authorization': 'Bearer ' + "{{ session['jwt_token'] }}" }
        }).done(res => handleResponse(res, submitMode, "/admin/monografi"));
    });
});
</script>
<script>
$(document).ready(function() {
    // --- 1. DATA & MAPPING GEOGRAFI ---
    var data_geo = JSON.parse('{{info_geo|tojson}}');

    // Mapping key database ke label tampilan grafik
    const mapping_geo = {
        "sawahteri": "Sawah Teririgasi",
        "luas": "Luas Wilayah",
        "sawahhu": "Sawah Tadah Hujan",
        "pemukiman": "Luas Pemukiman"
    };

    var tahun_geo = data_geo.map(item => item.tahun);
    var series_awal_geo = Object.keys(mapping_geo).map(key => ({
        name: mapping_geo[key],
        data: data_geo.map(item => item[key] || 0)
    }));

    // --- 2. INISIALISASI GRAFIK GEOGRAFI ---
    var options_geo = {
        series: series_awal_geo,
        chart: { 
            type: "bar", 
            height: 350, 
            toolbar: { show: false } 
        },
        // MENONAKTIFKAN NOMOR DI ATAS BATANG
        dataLabels: { 
            enabled: false 
        }, 
        plotOptions: { 
            bar: { 
                horizontal: false, 
                columnWidth: "45%", 
                borderRadius: 5 
            } 
        },
        xaxis: { 
            categories: tahun_geo 
        },
        yaxis: {
            forceNiceScale: true
        },
        colors: ['#00E396', '#FEB019', '#FF4560', '#775DD0'], // Warna pembeda kategori
        tooltip: { 
            theme: "dark" 
        }
    };

    var chart_geo = new ApexCharts($("#chart_geo")[0], options_geo);
    chart_geo.render();

    // --- 3. FUNGSI FILTER (DROPDOWN) ---
    function updateChartGeo() {
        var selectedYears = $("#yearDropdowngeo").val() || [];
        var selectedCategories = $("#categoryDropdowngeo").val() || [];
        
        var newSeries = selectedYears.map(year => {
            var row = data_geo.find(item => item.tahun == year) || {};
            return {
                name: year,
                data: selectedCategories.map(catKey => row[catKey] || 0)
            };
        });

        chart_geo.updateOptions({
            series: newSeries,
            dataLabels: { enabled: false }, // Pastikan angka tetap tidak muncul saat update
            xaxis: { 
                categories: selectedCategories.map(key => mapping_geo[key] || key) 
            }
        });
    }

    $("#yearDropdowngeo, #categoryDropdowngeo").on('change', updateChartGeo);

    // --- 4. LOGIKA ADMIN (ISI FORM OTOMATIS) ---
    // Gunakan ID select yang sesuai untuk tahun geografi, misal: #tahun_geo_select
    $('#tahun_geo_select').on('change', function() {
        var row = data_geo.find(item => item.tahun == $(this).val());
        if (row) {
            Object.keys(mapping_geo).forEach(key => {
                // Mengisi input dengan name yang sesuai (misal: sawahteri, luas, dll)
                $(`[name=${key}]`).val(row[key]);
            });
        }
    });
});
</script>
{% endblock %}