{% extends 'include/include.html' %} {% block content %}
<head>
  <style>
  .table-responsive {
    overflow-x: auto; /* Menambahkan scroll horizontal jika diperlukan */
  }
  
</style>
</head>
<div class="page-titles">
    <div class="row">
      <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0 d-flex align-items-center">
            <li class="breadcrumb-item">
              <a href="index.html" class="link"
                ><i class="ri-home-3-line fs-5"></i
              ></a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">admin/dashboard</li>
          </ol>
        </nav>
        <h1 class="mb-0 fw-bold">Dashboard</h1>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <!-- ============================================================= -->
    <!-- Start Page Content -->
    <!-- ============================================================= -->
    <!-- Row -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Welcome admin {{ session['username'] }}</h4>
            <h6 class="card-subtitle mb-0">
              anda dapat mengedit data yang ada di tampilan user
            </h6>
          </div>
        </div>
      </div>
      <div class="col-12">
        <h1> Grafik Monografi</h1>
      </div> 
      <div class="col-lg-12">
        <div class="card w-100">
          <div class="card-body">
            <div class="d-md-flex align-items-center">
              <div>
                <h3 class="card-title">Monografi desa</h3>
                <h6 class="card-subtitle">Grafik perbandingan menografi desa per tahun</h6>
              </div>
              <div class="ms-auto">
                <ul class="list-style-none">
                  <div class="container-fluid">
                    <div class="row mb-4">
                      <div class="col-lg-6">
                        <label for="categoryDropdown">Pilih Kategori:</label>
                        <select id="categoryDropdownmono" style="min-width: 150px;" class="form-control" multiple>
                          {% for field in fields_mono %}
                          <option value="{{ field.value }}">{{ field.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-lg-6">
                        <label for="yearDropdown">Pilih Tahun:</label>
                        <select id="yearDropdownmono" class="form-control" multiple>
                          {% for item in info_mono %}
                          <option value="{{ item.tahun }}">{{ item.tahun }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </ul>
              </div>
            </div>
            <div class="table-responsive">
            <div id="chart_mono" class="mt-4"></div>
          </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card w-100">
          <div class="card-body">
            <div class="d-md-flex align-items-center">
              <div class="col-md-8 col-lg-3">
                <h3 class="card-title">Geografi</h3>
                <h6 class="card-subtitle">Grafik Perubahan Geografi Desa (luas wilayah)</h6>
              </div>
              <div class="ms-auto ">
                <ul class="list-style-none">
                  <div class="container-fluid p-0">
                    <div class="row mb-4">
                      <div class="col-lg-6">
                        <label for="categoryDropdown">Pilih Kategori:</label>
                        <select id="categoryDropdowngeo" style="min-width: 150px;" class="form-control" multiple>
                          {% for field in fields_geo %}
                          <option value="{{ field.value }}">{{ field.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-lg-6">
                        <label for="yearDropdown">Pilih Tahun:</label>
                        <select id="yearDropdowngeo" class="form-control" multiple>
                          {% for item in info_geo %}
                          <option value="{{ item.tahun }}">{{ item.tahun }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </ul>
              </div>
            </div>
            <div class="table-responsive">
            <div id="chart_geo" class="mt-4"></div>
            </div>
          </div>
        </div>
      </div>
      </div>
    {% endblock %}

    {% block js %}
    <script>
    $(document).ready(function() {
    function getRandomColor() {
        let letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function colorDistance(color1, color2) {
        let r1 = parseInt(color1.slice(1, 3), 16);
        let g1 = parseInt(color1.slice(3, 5), 16);
        let b1 = parseInt(color1.slice(5, 7), 16);

        let r2 = parseInt(color2.slice(1, 3), 16);
        let g2 = parseInt(color2.slice(3, 5), 16);
        let b2 = parseInt(color2.slice(5, 7), 16);

        return Math.sqrt(
            (r2 - r1) * (r2 - r1) +
            (g2 - g1) * (g2 - g1) +
            (b2 - b1) * (b2 - b1)
        );
    }

    function generateRandomColors(count, minDistance = 100) {
        let colors = [];
        while (colors.length < count) {
            let color = getRandomColor();
            let isUnique = colors.every(existingColor => colorDistance(color, existingColor) > minDistance);

            if (isUnique) {
                colors.push(color);
            }
        }
        return colors;
    }

    var fields_mono = ['Jumalah Penduduk', 'Jumlah Kepala Keluarga', 'laki-laki', 'Perempuan', 'Jumlah KK Presejahtera', 'Jumlah KK Sejahtera', 'Jumlah KK Kaya',
    'Jumlah KK Sedang', 'Jumlah KK Miskin','Buruh', 'Petani', 'Peternak', 'Pedagang', 'Tukang Kayu', 'Tukang Batu', 'Penjahit', 'ASN',
    'Pensiunan', 'Perangkat Desa', 'Jasa Wiraswasta',
    'Pengrajin Batik', 'DLL', 'Islam', 'Kristen', 'Protestan', 'Katolik', 'Hindu', 'Budha'];

    // Parsing JSON
    var data_mono = JSON.parse('{{info_mono|tojson}}');
    console.log(data_mono);

    // Memisahkan data_mono berdasarkan tahun
    var dataByYear_mono = data_mono.reduce(function(acc, item) {
        if (!acc[item.tahun]) {
            acc[item.tahun] = {};
        }
        $.each(fields_mono, function(index, field) {
            if (!acc[item.tahun][field]) {
                acc[item.tahun][field] = [];
            }
            acc[item.tahun][field].push(item[field]);
        });
        return acc;
    }, {});

    // Mengambil kategori dari fields_mono
    var categories_mono = fields_mono;

    // Menyiapkan data untuk grafik
    var seriesData_mono = [];
    var colors_mono = []
    $.each(Object.keys(dataByYear_mono), function(index, year) {
        let color = generateRandomColors(1, 100)[0]; // Ambil satu warna dengan jarak minimum 100
        seriesData_mono.push({
            name: year,
            data: $.map(fields_mono, function(field) {
                return dataByYear_mono[year][field] ? dataByYear_mono[year][field][0] : 0; // Ambil nilai pertama dari array data
            }),
            color: color // Assign the generated color to this series
        });
        colors_mono.push(color);
    });

    // Membuat opsi grafik
    var options_mono = {
        series: seriesData_mono,
        chart: {
            type: "bar",
            height: 260,
            toolbar: {
                show: false,
            },
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: "42%",
                endingShape: "rounded",
                borderRadius: 5,
            },
        },
        dataLabels: {
            enabled: false,
        },
        xaxis: {
            categories: categories_mono,
        },
        yaxis: {
            show: true,
        },
        stroke: {
            show: true,
            width: 5,
            colors: ["transparent"],
        },
        tooltip: {
            theme: "dark",
        },
    };

    // Membuat dan merender grafik
    var chart_mono = new ApexCharts($("#chart_mono")[0], options_mono);
    chart_mono.render();

    var fields_geo = ["sawahteri", "luas", "sawahhu", "pemukiman"];

    // Parsing JSON
    var data_geo = JSON.parse('{{info_geo|tojson}}');
    console.log(data_geo);

    // Memisahkan data_geo berdasarkan tahun
    var dataByYear_geo = data_geo.reduce(function(acc, item) {
        if (!acc[item.tahun]) {
            acc[item.tahun] = {};
        }
        $.each(fields_geo, function(index, field) {
            if (!acc[item.tahun][field]) {
                acc[item.tahun][field] = [];
            }
            acc[item.tahun][field].push(item[field]);
        });
        return acc;
    }, {});

    // Mengambil kategori dari fields_geo
    var categories_geo = fields_geo;

    // Menyiapkan data untuk grafik
    var seriesData_geo = [];
    var colors_geo = []
    $.each(Object.keys(dataByYear_geo), function(index, year) {
        let color = generateRandomColors(1, 100)[0]; // Ambil satu warna dengan jarak minimum 100
        seriesData_geo.push({
            name: year,
            data: $.map(fields_geo, function(field) {
                return dataByYear_geo[year][field] ? dataByYear_geo[year][field][0] : 0; // Ambil nilai pertama dari array data
            }),
            color: color // Assign the generated color to this series
        });
        colors_geo.push(color)
    });

    // Membuat opsi grafik
    var options_geo = {
        series: seriesData_geo,
        chart: {
            type: "bar",
            height: 260,
            toolbar: {
                show: false,
            },
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: "42%",
                endingShape: "rounded",
                borderRadius: 5,
            },
        },
        dataLabels: {
            enabled: false,
        },
        xaxis: {
            categories: categories_geo,
        },
        yaxis: {
            show: true,
        },
        stroke: {
            show: true,
            width: 5,
            colors: ["transparent"],
        },
        tooltip: {
            theme: "dark",
        },
    };

    var chart_geo = new ApexCharts($("#chart_geo")[0], options_geo);
    chart_geo.render();

    function getSelectedValues(selectElement) {
        var selected = [];
        $(selectElement).find('option:selected').each(function() {
            selected.push($(this).val());
        });
        return selected;
    }

    function updateChart(init) {
        var year_id = "#yearDropdown" + init;
        console.log(year_id);
        var categori_id = "#categoryDropdown" + init;
        console.log(categori_id);
        var yearDropdown = $(year_id);
        var categoryDropdown = $(categori_id);
        var selectedYears = getSelectedValues(yearDropdown);
        console.log(selectedYears);
        var selectedCategories = getSelectedValues(categoryDropdown);
        console.log(selectedCategories);

        var newSeriesData = [];
        var newSeriesData = [];
    if (init == "mono") {
        $.each(selectedYears, function(index, year) {
            var seriesData = [];
            $.each(selectedCategories, function(index, category) {
                if (dataByYear_mono[year] && dataByYear_mono[year][category]) {
                    seriesData.push(dataByYear_mono[year][category][0]); // Mengambil data untuk kategori dan tahun
                } else {
                    seriesData.push(0);
                }
            });
            newSeriesData.push({
                name: year,
                data: seriesData
            });
        });
        
        chart_mono.updateOptions({
            series: newSeriesData,
            xaxis: {
                categories: selectedCategories.length > 0 ? selectedCategories : categories_mono
            }
        });
    } else if (init == "geo") {
        $.each(selectedYears, function(index, year) {
            var seriesData = [];
            $.each(selectedCategories, function(index, category) {
                if (dataByYear_geo[year] && dataByYear_geo[year][category]) {
                    seriesData.push(dataByYear_geo[year][category][0]); // Mengambil data untuk kategori dan tahun
                } else {
                    seriesData.push(0);
                }
            });
            newSeriesData.push({
                name: year,
                data: seriesData
            });
        });

        chart_geo.updateOptions({
            series: newSeriesData,
            xaxis: {
                categories: selectedCategories.length > 0 ? selectedCategories : categories_geo
            }
        });
    }
    }

    $("#yearDropdownmono").on('change', function() { updateChart("mono"); });
    $("#categoryDropdownmono").on('change', function() { updateChart("mono"); });
    $("#yearDropdowngeo").on('change', function() { updateChart("geo"); });
    $("#categoryDropdowngeo").on('change', function() { updateChart("geo"); });
});

    </script>
{% endblock %}